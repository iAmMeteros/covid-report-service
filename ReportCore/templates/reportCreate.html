{% extends "base.html" %}
{% load static %}
{% block title %}Обновление состояния{% endblock %}
{% block head %}
<script src="{% static 'fa/js/all.js'%}"></script>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/report.css' %}">
<script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
</link>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
</link>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
<script type="text/javascript">
    var map;
    var points = []

    DG.then(function () {
        return DG.plugin('https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js');
    }).then(function () {
        map = DG.map('map', {
            center: [53.22, 50.16],
            zoom: 12,
            poi: false,
            fullscreenControl: false,
            zoomControl: false
        });

        var markers = DG.markerClusterGroup({
            maxClusterRadius: 50
        });
        map.addLayer(markers);

        var markersA = []

        map.on('click', (e) => {
            var lat = e.latlng.lat
            var lng = e.latlng.lng
            var marker = DG.marker([lat, lng], {
                draggable: true
            })
            points.push([lat, lng])
            markersA.push(marker)
            markers.addLayer(marker)
            marker.on('click', () => {
                var index = markersA.indexOf(marker)
                points.splice(index, 1)
                markersA.splice(index, 1)
                markers.removeLayer(marker)
            })
            marker.on('drag', function (e) {
                var lat = e.target._latlng.lat.toFixed(3),
                    lng = e.target._latlng.lng.toFixed(3);
                index = markersA.indexOf(marker);
                points[index] = [lat, lng]
                console.log(points)
            });
        })

    });
</script>
{% endblock %}
{% block body %}
<div class="alert">
    <div class="message">
        <div class="close">
            <i class="far fa-times-circle"></i>
        </div>
        <div class="text">
            Заполните все поля!
        </div>
    </div>
</div>
<nav class="nav">
    <div class="container-fluid">
        <div class="logo">
            <a href="/">CovidReport</a>
        </div>
        <div id="mainListDiv" class="main_list">
            <ul class="navlinks">
                <li><a href="/map/"><i class="far fa-map"></i> Карта</a></li>
                <li><a href="/radar/"><i class="far fa-location"></i> Радар</a></li>
                <li><a href="/report/"><i class="far fa-engine-warning"></i> Репорт</a></li>
                {% if request.user.is_authenticated %}
                <li><a href="/logout/"><i class="far fa-user"></i> {{request.user.username}} | Выйти</a></li>
                {% else %}
                <li><a href="/login/"><i class="far fa-sign-in-alt"></i> Войти</a></li>
                {% endif %}
            </ul>
        </div>
        <span class="navTrigger">
            <i></i>
            <i></i>
            <i></i>
        </span>
    </div>
</nav>
<script>
    function sendForm(){
        $("form").submit();
    }
    $(".alert").fadeOut(1)
</script>
<div class="container-fluid content">
    <h1 class="title">Сообщите ваше состояние здоровья</h1>
    <form action="/report/" method="post">
        {% csrf_token %}
        <h3>Вам пришел результат теста?</h3>
        <div class="d-flex align-items-center">
            <div class="spandiv">
                <span class="span" style="margin-right: 0.5rem; margin-left: 0;">Нет</span>
            </div>
            <label class="switch">
                <input type="checkbox" name="has_result" id="has_result">
                <span class="slider round"></span>
            </label>
            <input type="hidden" name="has_result_h" value="false">
            <div class="spandiv">
                <span class="span" style="margin-left: 0.5rem;">Да</span>
            </div>
        </div>
        <div id="test_result_div">
            <h3>Результат вашего теста.</h3>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="test_result" value="p">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Положительный</span>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="test_result" value="n">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Отрицательный</span>
                </div>
            </div>
        </div>
        <div>
            <h3>Возможные контакты с носителями.</h3>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="contacts" value="n">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Контакта с носителями не наблюдалось</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="contacts" value="p">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Наблюдался контакт с потенциальным переносчиком вируса</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="contacts" value="a">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Наблюдался контакт с заражённым</span><br>
                </div>
            </div>
        </div>
        <div>
            <h3>Симптомы, которые у вас проявляются.</h3>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="TP">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Повышение температуры тела</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="DC">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Сухой кашель</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="FT">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Утомляемость</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="PS">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Различные болевые ощущения</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="ST">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Боль в горле</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="DR">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Диарея</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="CN">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Конъюнктивит</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="HD">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Головная боль</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="LT">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Потеря обоняния и вкусовых ощущений</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="SR">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Сыпь на коже</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="DB">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Затрудненное дыхание или одышка</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="CP">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Боль в грудной клетке</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="MF">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Нарушение речи или двигательных функций</span><br>
                </div>
            </div>
            <input type="hidden" name="symptomsStr" id="symptoms">
            <input type="hidden" name="places" id="places">
        </div>
        <div>
            <h3>Укажите места, которые вы недавно посещали</h3>
            <p>Нажмите на карту, чтобы добавить место. Нажмите на метку, чтобы удалить её. Вы можете перетаскивать
                метки.</p>
                <div id="map" style="height:600px"></div>
            </div>
            <div class="sendButton" onclick="sendForm()">Отправить <i class="far fa-paper-plane"></i></div>
    </form>
    <br>
    <br>
</div>
<div class="about">Made by <img src="{% static 'shpulke-black.png' %}" alt="" srcset=""></div>
<script>
    $("#test_result_div").hide();

    $('form').submit(() => {
        if ($("input[name='has_result']").is(":checked")){
            if (!$("input[name='test_result']").is(":checked")){
                $(".alert").fadeIn(200)
                $(".close").click(()=>{
                    $(".alert").fadeOut(200)
                })
                return false
            }
        }

        if(!$("input[name='contacts']").is(":checked")){
            $(".alert").fadeIn(200)
            $(".close").click(()=>{
                $(".alert").fadeOut(200)
            })
            return false
        }

        var symptoms = [];
        $('input:checked[name="symptoms"]').each((index, el) => {
            symptoms.push($(el).val());
        });
        $('#symptoms').val(symptoms.join(';'));
        $("#places").val(points.join(';'));
        return true
    });

    $('input[name="has_result"]').change(() => {
        if ($('input[name="has_result"]').is(":checked")) {
            $('input[name="has_result_h"]').val("true")
            $("#test_result_div").show(500)
            $('input[name="test_result"]').prop('required', true)
        } else {
            $('input[name="has_result_h"]').val("false")
            $("#test_result_div").hide(500)
            $('input[name="test_result"]').prop('required', false)
        }
    })
</script>
{% endblock %}