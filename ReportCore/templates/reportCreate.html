{% extends "report-base.html" %}
{% load static %}
{% block title %}Обновление состояния{% endblock %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/report.css' %}">

<script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
<script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
<script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-clustering.js"></script>

<link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
{% endblock %}
{% block content %}
<div class="alert">
    <div class="message">
        <div class="close">
            <i class="far fa-times-circle"></i>
        </div>
        <div class="text">
            Заполните все поля!
        </div>
    </div>
</div>
<script>
    function sendForm() {
        $("form").submit();
    }
    $(".alert").fadeOut(1)
</script>
<div class="container-fluid content">
    <h1 class="title">Сообщите ваше состояние здоровья</h1>
    <form action="/report/" method="post">
        {% csrf_token %}
        <h3>Вам пришел результат теста?</h3>
        <div class="d-flex align-items-center">
            <div class="spandiv">
                <span class="span" style="margin-right: 0.5rem; margin-left: 0;">Нет</span>
            </div>
            <label class="switch">
                <input type="checkbox" name="has_result" id="has_result">
                <span class="slider round"></span>
            </label>
            <input type="hidden" name="has_result_h" value="false">
            <div class="spandiv">
                <span class="span" style="margin-left: 0.5rem;">Да</span>
            </div>
        </div>
        <div id="test_result_div">
            <h3>Результат вашего теста.</h3>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="test_result" value="p">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Положительный</span>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="test_result" value="n">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Отрицательный</span>
                </div>
            </div>
        </div>
        <div>
            <h3>Возможные контакты с носителями.</h3>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="contacts" value="n">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Контакта с носителями не наблюдалось</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="contacts" value="p">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Наблюдался контакт с потенциальным переносчиком вируса</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="radio" name="contacts" value="a">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Наблюдался контакт с заражённым</span><br>
                </div>
            </div>
        </div>
        <div>
            <h3>Симптомы, которые у вас проявляются.</h3>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="TP">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Повышение температуры тела</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="DC">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Сухой кашель</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="FT">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Утомляемость</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="PS">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Различные болевые ощущения</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="ST">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Боль в горле</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="DR">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Диарея</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="CN">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Конъюнктивит</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="HD">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Головная боль</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="LT">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Потеря обоняния и вкусовых ощущений</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="SR">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Сыпь на коже</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="DB">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Затрудненное дыхание или одышка</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="CP">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Боль в грудной клетке</span><br>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <label class="switch">
                    <input type="checkbox" name="symptoms" value="MF">
                    <span class="slider round"></span>
                </label>
                <div class="spandiv">
                    <span class="span">Нарушение речи или двигательных функций</span><br>
                </div>
            </div>
            <input type="hidden" name="symptomsStr" id="symptoms">
            <input type="hidden" name="places" id="places">
        </div>
        <div>
            <h3>Укажите места, которые вы недавно посещали</h3>
            <p>Нажмите на карту, чтобы добавить место. Нажмите на метку, чтобы удалить её. Вы можете перетаскивать
                метки.</p>
            <div id="map" style="height:600px"></div>
        </div>
        <div class="sendButton" onclick="sendForm()">Отправить <i class="far fa-paper-plane"></i></div>
    </form>
    <br>
    <br>
</div>
<script>
    $("#test_result_div").hide();

    $('form').submit(() => {
        if ($("input[name='has_result']").is(":checked")) {
            if (!$("input[name='test_result']").is(":checked")) {
                $(".alert").fadeIn(200)
                $(".close").click(() => {
                    $(".alert").fadeOut(200)
                })
                return false
            }
        }

        if (!$("input[name='contacts']").is(":checked")) {
            $(".alert").fadeIn(200)
            $(".close").click(() => {
                $(".alert").fadeOut(200)
            })
            return false
        }

        var symptoms = [];
        $('input:checked[name="symptoms"]').each((index, el) => {
            symptoms.push($(el).val());
        });
        $('#symptoms').val(symptoms.join(';'));
        $("#places").val(points.join(';'));
        return true
    });

    $('input[name="has_result"]').change(() => {
        if ($('input[name="has_result"]').is(":checked")) {
            $('input[name="has_result_h"]').val("true")
            $("#test_result_div").show(500)
            $('input[name="test_result"]').prop('required', true)
        } else {
            $('input[name="has_result_h"]').val("false")
            $("#test_result_div").hide(500)
            $('input[name="test_result"]').prop('required', false)
        }
    })

    var platform = new H.service.Platform({
        'apikey': config.MAPS_API
    })

    var defaultLayers = platform.createDefaultLayers();

    var map = new H.Map(
        document.getElementById('map'),
        defaultLayers.vector.normal.map, {
            zoom: 12,
            center: {
                lat: 53.22,
                lng: 50.16
            }
        });

    window.addEventListener('resize', () => map.getViewPort().resize());
    var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

    var ui = H.ui.UI.createDefault(map, defaultLayers, 'ru-RU');

    var points = []
    var markers = []

    map.addEventListener('tap', function (e) {
        if (e.target instanceof H.map.Marker) {
            var index = markers.indexOf(e.target)
            points.splice(index, 1)
            markers.splice(index, 1)
            map.removeObject(e.target)
        } else {
            var coords = map.screenToGeo(e.currentPointer.viewportX, e.currentPointer.viewportY)
            var lat = coords.lat
            var lng = coords.lng

            var newMarker = new H.map.Marker({
                lat: lat,
                lng: lng
            }, {
                volatility: true
            })

            newMarker.draggable = true
            map.addObject(newMarker)
            map.setCenter(map.getCenter())
            markers.push(newMarker)
            points.push([lat, lng])
            map.addEventListener('dragstart', function (ev) {
                var target = ev.target,
                    pointer = ev.currentPointer;
                if (target instanceof H.map.Marker) {
                    var targetPosition = map.geoToScreen(target.getGeometry());
                    target['offset'] = new H.math.Point(pointer.viewportX - targetPosition.x, pointer
                        .viewportY - targetPosition.y);
                    behavior.disable();
                }
            }, false);

            map.addEventListener('dragend', function (ev) {
                var target = ev.target;
                if (target instanceof H.map.Marker) {
                    behavior.enable();
                }
            }, false);

            map.addEventListener('drag', function (ev) {
                var target = ev.target,
                    pointer = ev.currentPointer;
                if (target instanceof H.map.Marker) {
                    target.setGeometry(map.screenToGeo(pointer.viewportX - target['offset'].x, pointer
                        .viewportY - target['offset'].y));
                    points[markers.indexOf(target)] = [target.getGeometry().lat, target.getGeometry().lng]
                }
            }, false);
        }
    })
</script>
{% endblock %}