{% extends "report-base.html" %}
{% load static %}
{% block title %}Карта{% endblock %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/map.css' %}">

<script src="https://js.api.here.com/v3/3.1/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
<script src="https://js.api.here.com/v3/3.1/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
<script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-clustering.js"></script>

<link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

<script type="text/javascript">
    var coordsToAppend = {{coords}}
</script>
{% endblock %}
{% block content %}
<div class="container-fluid content">
    <h1 class="title">Карта эпидемиологической ситуации</h1>
    <form action="/map/" method="get">
        <label for="datePicker"><span class="label">По состоянию на: </span></label>
        <input class="label input" type="date" name="date" id="datePicker"><br><br>
    </form>
    <div id="map"></div>
</div>
<script>
    $(document).ready(function () {
        $('#datePicker').val('{{date}}');
        $('#datePicker').on('change', () => {
            $('form').submit()
        })
    })

    function addMarkers(map) {
        var svgQuestion =
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M192 0C86.4 0 0 86.4 0 192c0 76.8 25.6 99.2 172.8 310.4 4.8 6.4 12 9.6 19.2 9.6s14.4-3.2 19.2-9.6C358.4 291.2 384 268.8 384 192 384 86.4 297.6 0 192 0zm0 446.09c-14.41-20.56-27.51-39.12-39.41-55.99C58.35 256.48 48 240.2 48 192c0-79.4 64.6-144 144-144s144 64.6 144 144c0 48.2-10.35 64.48-104.59 198.09-11.9 16.87-25 35.44-39.41 56zM194.67 88c-41.81 0-76.9 29.3-85.81 68.45-2.28 9.99 5.2 19.55 15.44 19.55h16.84c7.22 0 13.19-4.99 15.33-11.88 5.07-16.27 20.27-28.12 38.2-28.12 25.98 0 40 20.61 40 40 0 15.96-20.07 27.19-50.67 42.5-8.14 4.07-13.33 12.4-13.33 21.5v16.16c0 8.75 7.09 15.84 15.84 15.84h16.32c8.75 0 15.84-7.09 15.84-15.84v-1.43c31.25-16.27 64-37.78 64-78.73 0-43.25-32.92-88-88-88zM192 288c-17.67 0-32 14.33-32 32s14.33 32 32 32 32-14.33 32-32-14.33-32-32-32z" fill="red"/></svg>'
        var questionIcon = new H.map.Icon(svgQuestion, {
            size: {
                h: 40,
                w: 30
            }
        })
        var svgDanger =
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M192 0C86.4 0 0 86.4 0 192c0 76.8 25.6 99.2 172.8 310.4 4.8 6.4 12 9.6 19.2 9.6s14.4-3.2 19.2-9.6C358.4 291.2 384 268.8 384 192 384 86.4 297.6 0 192 0zm0 446.09c-14.41-20.56-27.51-39.12-39.41-55.99C58.35 256.48 48 240.2 48 192c0-79.4 64.6-144 144-144s144 64.6 144 144c0 48.2-10.35 64.48-104.59 198.09-11.9 16.87-25 35.44-39.41 56zM192 256c-17.67 0-32 14.33-32 32s14.33 32 32 32 32-14.33 32-32-14.33-32-32-32zm28.72-160h-57.44c-10.02 0-17.57 9.1-15.73 18.95l18 96A16.001 16.001 0 0 0 181.28 224h21.44c7.7 0 14.31-5.48 15.73-13.05l18-96c1.84-9.85-5.71-18.95-15.73-18.95z" fill="red"/></svg>'
        var dangerIcon = new H.map.Icon(svgDanger, {
            size: {
                h: 40,
                w: 30
            }
        })

        var dataPoints = coordsToAppend.map(function (item){
            return new H.clustering.DataPoint(item[0], item[1], null, item[2] == 1)
        })

        var clusteredDataProvider = new H.clustering.Provider(dataPoints, {
            clusteringOptions: {
                eps: 30,
                minWeight: 2
            }
        })

        var defaultTheme = clusteredDataProvider.getTheme();

        var reportsTheme = {
            getClusterPresentation: function (cluster){
                var clusterMarker = defaultTheme.getClusterPresentation.call(defaultTheme, cluster)
                return clusterMarker
            },
            getNoisePresentation: function (noisePoint) {
                var noiseMarker = defaultTheme.getNoisePresentation.call(defaultTheme, noisePoint);
                console.log(noiseMarker.getData())
                var lat = noiseMarker.getData().b.lat
                var lng = noiseMarker.getData().b.lng
                if (noiseMarker.getData().a.data){
                    //Danger icon
                    var marker = new H.map.Marker({
                        lat: lat,
                        lng: lng
                    }, {
                        icon: dangerIcon,
                        min: noisePoint.getMinZoom()
                    })
                }else{
                    //Question icon
                    var marker = new H.map.Marker({
                        lat: lat,
                        lng: lng
                    }, {
                        icon: questionIcon,
                        min: noisePoint.getMinZoom()
                    })
                }
                return marker;
            }
        }

        clusteredDataProvider.setTheme(reportsTheme)

        var layer = new H.map.layer.ObjectLayer(clusteredDataProvider)

        map.addLayer(layer);

    }

    var platform = new H.service.Platform({
        'apikey': config.MAPS_API
    })

    var defaultLayers = platform.createDefaultLayers();

    var map = new H.Map(
        document.getElementById('map'),
        defaultLayers.vector.normal.map, {
            zoom: 12,
            center: {
                lat: 53.22,
                lng: 50.16
            }
        });

    window.addEventListener('resize', () => map.getViewPort().resize());
    var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

    var ui = H.ui.UI.createDefault(map, defaultLayers, 'ru-RU');

    addMarkers(map);
</script>
{% endblock %}